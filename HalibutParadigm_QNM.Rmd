---
title: "Qualitative Network Modeling in QPress"
author: "JMC"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
########################################################################
# All code was originally obtained from  Melbourne-Thomas et al. 2012. #
# Modified by Jon Reum and Jesse Coleman                               #
########################################################################

require(QPress)
require(dplyr)
require(purrr)
require(tidyr)
require(ggplot2)
require(reshape2)

```

```{r}
# Fix order of labels on adjacency plot
# Run once

adjacency.image <-
function (edges, required.groups = c(0), cex.axis = 1) 
{
    pal <- c("#92C5DE", "#FFFFFF", "#F4A582")
    A <- adjacency.matrix(edges, required.groups = required.groups)
    nodes <- node.labels(edges)
    n <- length(nodes)
    lwidth <- max(strwidth(nodes, units = "inches", cex = cex.axis))
    opar <- par(mai = c(0, lwidth + 0.2, lwidth + 0.2, 0) + 0.1)
    image(seq_len(n), seq_len(n), t(A)[, rev(seq_len(n))], axes = F, 
      xlab = "", ylab = "", col = pal)
    axis(2, seq_len(n), rev(nodes), las = 2, cex.axis = cex.axis)
    axis(3, seq_len(n), nodes, las = 2, cex.axis = cex.axis)
    box()
    par(opar)

}

environment(adjacency.image) <- as.environment("package:QPress")
```
# Saint Paul
## Digraph

![](/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Digraphs/SaintPaul.png)
Figure x. Digraph showing relationships (edges) between variables (nodes) for the St. Paul community model.

```{r Run QPress}
# Load in the community model

digraph.stpaul = paste("/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Dia Files/", expression(stpaul), ".dia", sep = "")

edges.stpaul <- model.dia(digraph.stpaul)

## Examine unweighted adjacency matrix

A.stpaul <- adjacency.matrix(edges.stpaul, labels = TRUE)

# write.csv(file = paste("/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Community Matrices/comm_matrix_", expression(stpaul), ".csv", sep = ""), x = A.stpaul)

# Take a peek at the adjacency matrix

## Function to add in -1 on the diagonal generate the community matrix

edgesNeg.stpaul <- enforce.limitation(edges.stpaul)
adj_mat.stpaul <- adjacency.matrix(edgesNeg.stpaul,labels = TRUE)

# png(filename = paste("/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Plots/adj_image_", expression(stpaul),".png", sep = ""), units = "px", height = 700, width = 1000)

adjacency.image(edgesNeg.stpaul)

# dev.off()

# 1. Build a set of stable matrices, 

sim.stpaul <<- system.simulate(n.sims = 1000, edges = edgesNeg.stpaul, 
  sampler = community.sampler(edgesNeg.stpaul), validators = NULL) 

```
Figure x.  Representation of the Saint Paul community matrix in which blue cells indicate a negative effect of column node on row node, and orange indicate a positive effect. Diagonals in blue indicate that each node in the system is assumed to be self-limiting.


***

# Saint Paul
## Press perturbation: increase halibut abundance

```{r Simulation output}
# We could add additional validation criteria to filter out matricies that don't reproduce a known system behavior 

# The sim object contains the inverse community matrcies, their corresponding edge weights, and a few other things.... 

# Look at the proportion of stable matrices when drawing edge weights from uniform distributions

# sim.stpaul$stable / sim.stpaul$total

# 2. Interactively expore how the nodes respond to different press scenarios

impact.barplot(sim.stpaul)
```
![](/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Plots/imp_plot_stpaul_1.png)
Figure x. Impact barpot of simulated responses to an increase in halibut abundance for St. Paul community model. The proportion of simulated stable (retained) matrices that had a negative response at the node in question is shown in blue, and the proportion of stable matrices in which that node had a positive response is shown in orange.


## Press perturbation: decrease halibut bycatch limits

![](/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Plots/imp_plot_stpaul_2.png)
Figure x. Impact barpot of simulated responses to a decrease in halibut bycatch limits for St. Paul community model. The proportion of simulated stable (retained) matrices that had a negative response at the node in question is shown in blue, and the proportion of stable matrices in which that node had a positive response is shown in orange.

```{r}
# Look at how the community responds when nodes are pressed one at a time.
imptable.stpaul <- impact.table(sim.stpaul)

# write.csv(file = paste("/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Output/imp_table_", expression(stpaul), ".csv", sep = ""), x = imptable.stpaul)

formattable(imptable.stpaul, color_tile("#92C5DE", "#F4A582"))
formattable(round(imptable.stpaul, 2), list(~ color_tile("#92C5DE", "#F4A582")))

# Which node perturbations have similar community outcomes?

imp_dist_pert.stpaul <- dist(t(imptable.stpaul))

# png(filename = paste("/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Plots/pert_dist_", expression(stpaul), ".png", sep = ""), units = "px", height = 700, width = 1000)

plot(hclust(imp_dist_pert.stpaul), main = "Perturbation similarity (Euclidean distance)", hang = -1)

# dev.off()

imp_dist_node.stpaul <- dist(imptable.stpaul)

# png(filename = paste("/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Plots/node_dist_", expression(stpaul), ".png", sep = ""), units = "px", height = 700, width = 1000)

plot(hclust(imp_dist_node.stpaul), main = "Node similarity across perturbations (Euclidean distance)", hang = -1)

# dev.off()
```

```{r Map QPress over all models}

# Create list of path names to Dia models

dia_paths <- list(stpaul = "/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Dia Files/stpaul.dia", 
                  savoonga = "/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Dia Files/savoonga.dia",
                  unalaska = "/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Dia Files/unalaskadutch.dia",
                  am80 = "/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Dia Files/am80.dia")


# Convert Dia digraphs to table for use in QPress simulations

edges <- map(dia_paths, model.dia)


# Add self-limitation of each node (i.e., -1 on the diagonal of the community matrix)

edges_lim <- edges %>% map(~ enforce.limitation(.))


# Build adjacency (community) matrices for all models

adj_mats <- edges_lim %>% map(~ adjacency.matrix(labels = TRUE, edges = .))


# Produce plot of adjacency matrices (effect of column node on row node) with light blue for negative and orange for positive interactions.


adjacency.image2 = function(edges, modelname) {
  ggplot(edges %>% complete(From, nesting(To), fill = list(Type = "Z")), 
            aes(y = rev(To), x = From, fill = Type)) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("#81B8D6", "#EF936F", "808080"), 
                    name = "Interaction", 
                    labels = c("Neg", "Pos", "Zero")) +
  theme_minimal() + 
  labs(y = "", x = paste(modelname)) +
  scale_y_discrete(expand = c(0, 0), labels = rev(levels(edges$From))) +
  scale_x_discrete(position = "top", expand = c(0, 0)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0), 
        axis.ticks = element_blank())
  
}

adj_images <- map2(.x = edges_lim, .y = names(edges_lim), .f = adjacency.image2)

# Run simulations
# Not working...in progress

argslist <-list(
  n.sims <- c(rep(1000, 4)),
  edges <- edges_lim,
  required.groups <- c(rep(c(0))),
  sampler <- community.sampler(edges_lim),
  validators <- c(rep(NULL, 4))
)


sims <<- pmap(.l = argslist, .f = system.simulate)
             
# Arguments called in original code 
# (n.sims = 1000, edges = edges_lim, 
# sampler = community.sampler(edgesNeg.stpaul), validators = NULL)

sims <- list(
  stpaul = system.simulate(n.sims = 1000, edges = edges_lim$stpaul, sampler = community.sampler(edges_lim$stpaul), validators = NULL),
  savoonga = system.simulate(n.sims = 1000, edges = edges_lim$savoonga, sampler = community.sampler(edges_lim$savoonga), validators = NULL),
  unalaska = system.simulate(n.sims = 1000, edges = edges_lim$unalaska, sampler = community.sampler(edges_lim$unalaska), validators = NULL),
  am80 = system.simulate(n.sims = 1000, edges = edges_lim$am80, sampler = community.sampler(edges_lim$am80), validators = NULL)
)
# Create impact tables for each model; values are positive press perturbation of column node impacts (-1 to 1) on row nodes

imptables <- map(.x = sims, .f = impact.table)

# Create heat maps of impact tables
heatimptable <- function(imptable) {
  ggplot(melt(imptable), aes(Var2, Var1, fill = value)) +
    geom_tile(color = "white") +
    scale_fill_gradient2(low = "#81B8D6", high = "#EF936F", mid = "808080", 
                         midpoint = 0, limit = c(-1,1), space = "Lab", guide = FALSE) +
    geom_text(aes(Var2, Var1, label = round(value, 2)), color = "black", size = 4) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, vjust = 1, size = 10, hjust = 1),
      axis.text.y = element_text(size = 10),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      panel.grid.major = element_blank(),
      panel.border = element_blank(),
      panel.background = element_blank(),
      axis.ticks = element_blank(),
      legend.justification = c(1, 0),
      legend.position = c(0.6, 0.7),
      legend.direction = "horizontal")
  
}

heatimptables <- map(.x = imptables, .f = heatimptable)


# Which node perturbations have similar community outcomes?

imp_dist_pert <- map(.x = imptables, .f = ~ dist(t(.)))

# png(filename = paste("/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Plots/pert_dist_", expression(stpaul), ".png", sep = ""), units = "px", height = 700, width = 1000)

imp_dist_pert_plot <- map(.x = imp_dist_pert, .f = ~ hclust(.))
main = paste(names(.), "Perturbation similarity", sep = " "), hang = -1))

# dev.off()

imp_dist_node.stpaul <- dist(imptable.stpaul)

# png(filename = paste("/Volumes/GoogleDrive/My Drive/Halibut Paradigm/Plots/node_dist_", expression(stpaul), ".png", sep = ""), units = "px", height = 700, width = 1000)

plot(hclust(imp_dist_node.stpaul), main = "Node similarity across perturbations (Euclidean distance)", hang = -1)

```

